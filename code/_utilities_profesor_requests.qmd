---
title: "Quantitative biodiversity modelling for finance and companies"
subtitle: "Project 1: compare metrics"
author: 
  - name: "Carlos Muñoz"
    email: carlos_jair.munoz@cec.lu.se
    affiliations: 
      - ref: CEC

affiliations:
  - id: CEC
    name: Centre for Environmental and Climate Science, Lund University
    department: Centre for Environmental and Climate Science 
    address: Kontaktvägen 10
    city: Lund
    postal-code: 22362
    url: https://www.cec.lu.se/home
   
format:
  html:
    theme: cosmo # try other themes from https://quarto.org/docs/output-formats/html-themes.html
    toc: true # this will enable Table of Contents
    code-fold: false #try changing it and see what happens
    embed-resources: true # this is so your file would embed all images. 
    output-dir: "../quarto_reports/"  
  pdf: default
  docx: default

execute: 
  echo: true    #use to show/hide R-code in the report
  cache: false
number-sections: true #sectioner can be automatically numbered
title-block-banner: true
---

Request: a table showing the bird species of the swedish bird survey, habitat sensu avonet, and forest birds sensu Solonen (1994) and Bakx et al (2023), as well which ones were used to run preliminary models nngp_2rl models with 100 thin and 1000 samples

## Data

```{r, setup}
knitr::opts_knit$set(root.dir = "c:/Users/Carlos Munoz/Documents/Ph.D/6_courses/2025_I_comparative_metrics/")
```

```{r}
#| message: false
#| warning: false

library(Hmsc)
library(openxlsx)
```

### Swedish bird survey (sbs)

Data from the swedish bird survey (sbs)

```{r}
# species data (names and keys)
sbs <- read.xlsx("data/sbs/public_eurolist.xlsx", sheet = 1) |> 
  filter(taxon_rank == "species", class == "Aves")

```

There are `r nrow(spp)` species observed in the data set.

### Avonet

Data from Avonet https://opentraits.org/datasets/avonet

```{r}
avonet <- read.csv("data/traits/AVONET/TraitData/AVONET_Raw_Data.csv")|>
  select(Avibase.ID, Species1_BirdLife, Species2_eBird, eBird.species.group, Species3_BirdTree) |> 
  distinct(Avibase.ID, .keep_all = TRUE)
```

### Forest birds (Solonen, 1993; Bakx et al, 2023)

Species associated to forest according Bakx and Solonen (1994). https://esajournals.onlinelibrary.wiley.com/doi/full/10.1002/ecs2.4559

```{r}
sppForest <- read.xlsx("data/Bakx_2023_forest_list.xlsx", sheet = 1)

sppForest$Latin.name[!(sppForest$Latin.name %in% sbs$latin)]

```
```{r}
# just to get this table, if I want to automatize this workflow i have to find another way
sbs[sbs$latin == "Dryobates minor", "latin"] <- "Dendrocopos minor" # Dendrocopus minor is in birdtree
sbs[sbs$latin == "Curruca curruca", "latin"] <- "Sylvia althaea" # 	Sylvia althaea is in birdtree
```


### Taxonomical workflow

We have to resolve taxonomic names used in the Avonet Dataset, Forest database, and the bird survey.


```{r}
spp <- sbs$latin

sppTax <- data.frame("sbs" = NA, "species" = NA, "s1" = NA, "s2" = NA, "s3" = NA)

for(i in 1:length(spp)){
    
    spp.i <- spp[i]
    
    sppTax[i, "sbs" ] <- spp.i
    
    sppTax[i, "species" ] <- spp.i
    
    
    isMissing1 <- !(spp.i %in% avonet$Species1_BirdLife)
    sppTax[i, "s1" ] <- isMissing1*1
    
    isMissing2 <- !(spp.i %in% avonet$Species2_eBird)
    sppTax[i, "s2" ] <- isMissing2*1
    
    isMissing3 <- !(spp.i %in% avonet$Species3_BirdTree)
    sppTax[i, "s3" ] <- isMissing3*1
    
    isMissing4 <- !(spp.i %in% sppForest$Latin.name)
    sppTax[i, "s4" ] <- isMissing4*1
    
}

rm(isMissing1, isMissing2, isMissing3, missed3, spp.i, i)

index <- which(rowSums(sppTax[3:5]) == 3)

sppY <- spp[index]

sppY[sppY == "Corvus cornix"] <- "Corvus corone"
sppY[sppY =="Loxia bifasciata"] <- "Loxia leucoptera"
sppY[sppY =="Curruca cantillans"] <- "Sylvia cantillans"
sppY[sppY =="Columba livia f. domestica"] <- "Columba livia"
sppY[sppY =="Anarhynchus alexandrinus"] <- "Charadrius alexandrinus"
sppY[sppY =="Anarhynchus leschenaultii"] <- "Charadrius leschenaultii"

for(a in 1:length(sppY)){

    spp.a <- sppY[a]
    ai <- index[a]
    
    sppTax[ai, "species" ] <- spp.a
    
    
    isMissing1 <- !(spp.a %in% avonet$Species1_BirdLife)
    sppTax[ai, "s1" ] <- isMissing1*1
    
    isMissing2 <- !(spp.a %in% avonet$Species2_eBird)
    sppTax[ai, "s2" ] <- isMissing2*1
    
    isMissing3 <- !(spp.a %in% avonet$Species3_BirdTree)
    sppTax[ai, "s3" ] <- isMissing3*1
    
}
```

```{r}
s1 <- read.csv("data/traits/AVONET/TraitData/AVONET1_BirdLife.csv") |>
  select(Species1, Habitat) |> 
  rename(s1 = Species1, Habitat = Habitat)
s2 <- read.xlsx("data/traits/AVONET/TraitData/AVONET2_eBird.xlsx", sheet = 2)|>
  select(Species2, Habitat)|> 
  rename(s2 = Species2, Habitat = Habitat)
s3 <- read.xlsx("data/traits/AVONET/TraitData/AVONET3_BirdTree.xlsx", sheet = 2)|>
  select(Species3, Habitat)|> 
  rename(s3 = Species3, Habitat = Habitat)

s <- list("s1" = s1, "s2" = s2, "s3" = s3)

```


```{r}
hab <- data.frame("species" = NA, "s1" = NA, "s2" = NA, "s3" = NA)

habsAll <- character()
  
for(c in 1:nrow(sppTax)){

  sppC <-  sppTax[c, 2]
  rowC <- sppTax[c, 3:5] |> t() 
  
  sc <- c("s1", "s2", "s3")
  
  index.c <- which(rowC == 0)
  
  habs <- character()
  
  for(r in 1:length(index.c)){
   r.i <- index.c[r]
   sc.r <- sc[r.i]
   df <- s[[sc.r]]
   index.r <- which(sppC == df[, sc.r])
   hab.r <- df[index.r, "Habitat"]
   habs[r] <- hab.r
  }
  
  habsUnique <- unique(habs)
  
  if(length(habsUnique) > 1){
    warning(paste0("THERE IS MORE THAN ONE HABITAT FOR THE SPECIES: ", sc.r, " NUMBER: ", c ))
  }
  
  habsAll[c] <- habsUnique
  
}

sppTax$Habitats <- habsAll 


```


```{r}

load("models/unfitted_models_NGPP.RData")

sppUsing <- models[[1]]$Y |> colnames()

sppTax$Using <- sppTax$sbs %in% sppUsing

write.xlsx(sppTax, "species_habitat_sbs_and_if_used.xlsx")

```

```{r}
table(sppTax$Habitats, sppTax$Using)
```

```{r}
sppForest$Latin.name %in% avonet$Species3_BirdTree |> sum()
```


